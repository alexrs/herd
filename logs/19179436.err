Loaded module: cuda/11.6
Loaded dependency [python3/3.11.4]: gcc/12.3.0-binutils-2.40
Loaded dependency [python3/3.11.4]: sqlite3/3.42.0
Loaded module: python3/3.11.4

Loading python3/3.11.4
  Loading requirement: gcc/12.3.0-binutils-2.40 sqlite3/3.42.0
Found cached dataset parquet (/work3/s212722/herd/datasets/cache/alexrs___parquet/alexrs--alpaca-cleaned-10-clusters-e0d2361138237477/0.0.0/14a00e99c0d15a23649d0db8944380ac81082d4b021f398733dd84f3a6c569a7)
2023-11-08 12:42:16.860 | INFO     | herd.finetune_utils:get_peft_config:30 - Fine-tuning with MoLoRA using 10 experts
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|‚ñà‚ñà‚ñà‚ñà‚ñà     | 1/2 [03:52<03:52, 232.52s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 2/2 [05:04<00:00, 137.95s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 2/2 [05:04<00:00, 152.14s/it]
2023-11-08 12:47:29.170 | INFO     | herd.finetune:_finetune_router:169 - Loading experts: dict_keys(['expert_0', 'expert_1', 'expert_2', 'expert_3', 'expert_4', 'expert_5', 'expert_6', 'expert_7', 'expert_8', 'expert_9'])
/zhome/03/c/164482/code/herd/.venv/lib/python3.11/site-packages/trl/trainer/utils.py:246: UserWarning: The passed formatting_func has more than one argument. Usually that function should have a single argument `example` which corresponds to the dictonnary returned by each element of the dataset. Make sure you know what you are doing.
  warnings.warn(
2023-11-08 12:47:29.867 | INFO     | herd.finetune:_finetune_router:181 - Peft Config: MoloraConfig(peft_type=<PeftType.MOLORA: 'MOLORA'>, auto_mapping=None, base_model_name_or_path='meta-llama/Llama-2-7b-hf', revision=None, task_type='CAUSAL_LM', inference_mode=False, r=4, target_modules=['q_proj', 'v_proj'], lora_alpha=8, lora_dropout=0.1, fan_in_fan_out=False, bias='none', modules_to_save=None, init_lora_weights=True, layers_to_transform=None, layers_pattern=None, rank_pattern={}, alpha_pattern={}, num_experts=10, only_router=True, train_single_expert=False, experts_to_combine=['expert_0', 'expert_1', 'expert_2', 'expert_3', 'expert_4', 'expert_5', 'expert_6', 'expert_7', 'expert_8', 'expert_9'], top_k=0, top_p=0.0, self_attn_router=True, self_attn_hidden_dim=4, self_attn_use_value=False, random_routing=False, uniform_routing=False, dot_product_routing=False)
2023-11-08 12:47:29.868 | INFO     | herd.finetune:_finetune_router:182 - Training router, output_dir: /work3/s212722/herd/meta-llama/Llama-2-7b-hf/alpaca-10/q_v_r4/molora/router_self_attn_4
wandb: Currently logged in as: alexrs95. Use `wandb login --relogin` to force relogin
wandb: wandb version 0.16.0 is available!  To upgrade, please run:
wandb:  $ pip install wandb --upgrade
wandb: Tracking run with wandb version 0.15.10
wandb: Run data is saved locally in /zhome/03/c/164482/code/herd/wandb/run-20231108_124732-z95kpeni
wandb: Run `wandb offline` to turn off syncing.
wandb: Syncing run molora/router_self_attn_4
wandb: ‚≠êÔ∏è View project at https://wandb.ai/alexrs95/herd-llama
wandb: üöÄ View run at https://wandb.ai/alexrs95/herd-llama/runs/z95kpeni
  0%|          | 0/12940 [00:00<?, ?it/s]You're using a LlamaTokenizerFast tokenizer. Please note that with a fast tokenizer, using the `__call__` method is faster than using a method to encode the text followed by a call to the `pad` method to get a padded encoding.
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`...
  0%|          | 1/12940 [00:14<51:17:52, 14.27s/it]  0%|          | 2/12940 [00:25<45:32:06, 12.67s/it]  0%|          | 3/12940 [00:37<43:39:21, 12.15s/it]  0%|          | 4/12940 [00:48<42:48:39, 11.91s/it]  0%|          | 5/12940 [01:00<42:21:35, 11.79s/it]  0%|          | 6/12940 [01:12<42:05:45, 11.72s/it]  0%|          | 7/12940 [01:23<41:56:30, 11.67s/it]  0%|          | 8/12940 [01:35<41:50:38, 11.65s/it]  0%|          | 9/12940 [01:46<41:47:11, 11.63s/it]  0%|          | 10/12940 [01:58<41:45:04, 11.62s/it]                                                       0%|          | 10/12940 [01:58<41:45:04, 11.62s/it]  0%|          | 11/12940 [02:10<41:43:41, 11.62s/it]  0%|          | 12/12940 [02:21<41:42:24, 11.61s/it]  0%|          | 13/12940 [02:33<41:42:14, 11.61s/it]  0%|          | 14/12940 [02:44<41:41:54, 11.61s/it]  0%|          | 15/12940 [02:56<41:41:30, 11.61s/it]  0%|          | 16/12940 [03:08<41:41:26, 11.61s/it]  0%|          | 17/12940 [03:19<41:41:14, 11.61s/it]  0%|          | 18/12940 [03:31<41:41:48, 11.62s/it]  0%|          | 19/12940 [03:42<41:41:22, 11.62s/it]  0%|          | 20/12940 [03:54<41:41:11, 11.62s/it]                                                       0%|          | 20/12940 [03:54<41:41:11, 11.62s/it]  0%|          | 21/12940 [04:06<41:41:01, 11.62s/it]  0%|          | 22/12940 [04:17<41:40:34, 11.61s/it]  0%|          | 23/12940 [04:29<41:40:36, 11.62s/it]  0%|          | 24/12940 [04:41<41:40:49, 11.62s/it]  0%|          | 25/12940 [04:52<41:40:45, 11.62s/it]  0%|          | 26/12940 [05:04<41:40:26, 11.62s/it]  0%|          | 27/12940 [05:15<41:40:20, 11.62s/it]  0%|          | 28/12940 [05:27<41:40:06, 11.62s/it]  0%|          | 29/12940 [05:39<41:39:46, 11.62s/it]  0%|          | 30/12940 [05:50<41:39:32, 11.62s/it]                                                       0%|          | 30/12940 [05:50<41:39:32, 11.62s/it]  0%|          | 31/12940 [06:02<41:39:20, 11.62s/it]  0%|          | 32/12940 [06:13<41:39:04, 11.62s/it]  0%|          | 33/12940 [06:25<41:38:58, 11.62s/it]  0%|          | 34/12940 [06:37<41:38:48, 11.62s/it]  0%|          | 35/12940 [06:48<41:38:59, 11.62s/it]  0%|          | 36/12940 [07:00<41:38:27, 11.62s/it]  0%|          | 37/12940 [07:12<41:38:01, 11.62s/it]  0%|          | 38/12940 [07:23<41:37:34, 11.61s/it]  0%|          | 39/12940 [07:35<41:37:57, 11.62s/it]  0%|          | 40/12940 [07:46<41:37:41, 11.62s/it]                                                       0%|          | 40/12940 [07:46<41:37:41, 11.62s/it]  0%|          | 41/12940 [07:58<41:37:13, 11.62s/it]  0%|          | 42/12940 [08:10<41:37:26, 11.62s/it]  0%|          | 43/12940 [08:21<41:37:05, 11.62s/it]  0%|          | 44/12940 [08:33<41:37:02, 11.62s/it]  0%|          | 45/12940 [08:44<41:36:35, 11.62s/it]  0%|          | 46/12940 [08:56<41:36:11, 11.62s/it]  0%|          | 47/12940 [09:08<41:36:16, 11.62s/it]  0%|          | 48/12940 [09:19<41:35:52, 11.62s/it]  0%|          | 49/12940 [09:31<41:35:39, 11.62s/it]  0%|          | 50/12940 [09:43<41:35:53, 11.62s/it]                                                       0%|          | 50/12940 [09:43<41:35:53, 11.62s/it]  0%|          | 51/12940 [09:54<41:35:48, 11.62s/it]  0%|          | 52/12940 [10:06<41:35:29, 11.62s/it]  0%|          | 53/12940 [10:17<41:35:39, 11.62s/it]  0%|          | 54/12940 [10:29<41:35:21, 11.62s/it]  0%|          | 55/12940 [10:41<41:35:17, 11.62s/it]  0%|          | 56/12940 [10:52<41:35:03, 11.62s/it]  0%|          | 57/12940 [11:04<41:34:33, 11.62s/it]  0%|          | 58/12940 [11:16<41:34:13, 11.62s/it]  0%|          | 59/12940 [11:27<41:34:19, 11.62s/it]  0%|          | 60/12940 [11:39<41:34:17, 11.62s/it]                                                       0%|          | 60/12940 [11:39<41:34:17, 11.62s/it]  0%|          | 61/12940 [11:50<41:34:05, 11.62s/it]  0%|          | 62/12940 [12:02<41:33:52, 11.62s/it]  0%|          | 63/12940 [12:14<41:33:46, 11.62s/it]  0%|          | 64/12940 [12:25<41:33:32, 11.62s/it]  1%|          | 65/12940 [12:37<41:33:10, 11.62s/it]  1%|          | 66/12940 [12:48<41:32:56, 11.62s/it]  1%|          | 67/12940 [13:00<41:32:53, 11.62s/it]  1%|          | 68/12940 [13:12<41:32:19, 11.62s/it]  1%|          | 69/12940 [13:23<41:32:05, 11.62s/it]  1%|          | 70/12940 [13:35<41:31:57, 11.62s/it]                                                       1%|          | 70/12940 [13:35<41:31:57, 11.62s/it]  1%|          | 71/12940 [13:47<41:32:01, 11.62s/it]  1%|          | 72/12940 [13:58<41:31:44, 11.62s/it]  1%|          | 73/12940 [14:10<41:31:38, 11.62s/it]  1%|          | 74/12940 [14:21<41:31:19, 11.62s/it]  1%|          | 75/12940 [14:33<41:31:37, 11.62s/it]  1%|          | 76/12940 [14:45<41:31:24, 11.62s/it]  1%|          | 77/12940 [14:56<41:31:17, 11.62s/it]  1%|          | 78/12940 [15:08<41:31:01, 11.62s/it]  1%|          | 79/12940 [15:20<41:30:41, 11.62s/it]  1%|          | 80/12940 [15:31<41:30:27, 11.62s/it]                                                       1%|          | 80/12940 [15:31<41:30:27, 11.62s/it]  1%|          | 81/12940 [15:43<41:30:27, 11.62s/it]  1%|          | 82/12940 [15:54<41:30:06, 11.62s/it]  1%|          | 83/12940 [16:06<41:29:40, 11.62s/it]  1%|          | 84/12940 [16:18<41:29:21, 11.62s/it]  1%|          | 85/12940 [16:29<41:28:51, 11.62s/it]  1%|          | 86/12940 [16:41<41:28:53, 11.62s/it]  1%|          | 87/12940 [16:52<41:28:42, 11.62s/it]  1%|          | 88/12940 [17:04<41:28:31, 11.62s/it]  1%|          | 89/12940 [17:16<41:28:05, 11.62s/it]  1%|          | 90/12940 [17:27<41:28:12, 11.62s/it]                                                       1%|          | 90/12940 [17:27<41:28:12, 11.62s/it]  1%|          | 91/12940 [17:39<41:27:56, 11.62s/it]  1%|          | 92/12940 [17:51<41:28:14, 11.62s/it]  1%|          | 93/12940 [18:02<41:27:48, 11.62s/it]  1%|          | 94/12940 [18:14<41:30:18, 11.63s/it]  1%|          | 95/12940 [18:25<41:29:22, 11.63s/it]  1%|          | 96/12940 [18:37<41:28:26, 11.62s/it]  1%|          | 97/12940 [18:49<41:28:09, 11.62s/it]  1%|          | 98/12940 [19:00<41:27:30, 11.62s/it]  1%|          | 99/12940 [19:12<41:27:20, 11.62s/it]  1%|          | 100/12940 [19:24<41:26:40, 11.62s/it]                                                        1%|          | 100/12940 [19:24<41:26:40, 11.62s/it]  1%|          | 101/12940 [19:35<41:26:27, 11.62s/it]  1%|          | 102/12940 [19:47<41:25:55, 11.62s/it]  1%|          | 103/12940 [19:58<41:25:44, 11.62s/it]  1%|          | 104/12940 [20:10<41:25:29, 11.62s/it]  1%|          | 105/12940 [20:22<41:25:03, 11.62s/it]  1%|          | 106/12940 [20:33<41:25:11, 11.62s/it]  1%|          | 107/12940 [20:45<41:25:00, 11.62s/it]  1%|          | 108/12940 [20:56<41:24:52, 11.62s/it]  1%|          | 109/12940 [21:08<41:24:19, 11.62s/it]  1%|          | 110/12940 [21:20<41:24:02, 11.62s/it]                                                        1%|          | 110/12940 [21:20<41:24:02, 11.62s/it]  1%|          | 111/12940 [21:31<41:23:45, 11.62s/it]  1%|          | 112/12940 [21:45<43:50:25, 12.30s/it]  1%|          | 113/12940 [21:57<43:05:25, 12.09s/it]  1%|          | 114/12940 [22:08<42:33:56, 11.95s/it]  1%|          | 115/12940 [22:20<42:11:59, 11.85s/it]  1%|          | 116/12940 [22:32<41:56:51, 11.78s/it]  1%|          | 117/12940 [22:43<41:46:35, 11.73s/it]  1%|          | 118/12940 [22:55<41:38:44, 11.69s/it]  1%|          | 119/12940 [23:07<41:33:25, 11.67s/it]  1%|          | 120/12940 [23:18<41:29:13, 11.65s/it]                                                        1%|          | 120/12940 [23:18<41:29:13, 11.65s/it]  1%|          | 121/12940 [23:30<41:26:31, 11.64s/it]  1%|          | 122/12940 [23:41<41:24:43, 11.63s/it]  1%|          | 123/12940 [23:53<41:23:13, 11.62s/it]  1%|          | 124/12940 [24:05<41:22:25, 11.62s/it]  1%|          | 125/12940 [24:16<41:21:38, 11.62s/it]  1%|          | 126/12940 [24:28<41:20:52, 11.62s/it]  1%|          | 127/12940 [24:39<41:20:21, 11.61s/it]  1%|          | 128/12940 [24:51<41:19:52, 11.61s/it]  1%|          | 129/12940 [25:03<41:19:32, 11.61s/it]  1%|          | 130/12940 [25:14<41:19:22, 11.61s/it]                                                        1%|          | 130/12940 [25:14<41:19:22, 11.61s/it]  1%|          | 131/12940 [25:26<41:18:55, 11.61s/it]  1%|          | 132/12940 [25:37<41:18:32, 11.61s/it]  1%|          | 133/12940 [25:49<41:18:16, 11.61s/it]  1%|          | 134/12940 [26:01<41:18:12, 11.61s/it]  1%|          | 135/12940 [26:12<41:18:05, 11.61s/it]  1%|          | 136/12940 [26:24<41:18:12, 11.61s/it]  1%|          | 137/12940 [26:36<41:17:42, 11.61s/it]  1%|          | 138/12940 [26:47<41:17:24, 11.61s/it]  1%|          | 139/12940 [26:59<41:17:23, 11.61s/it]  1%|          | 140/12940 [27:10<41:17:12, 11.61s/it]                                                        1%|          | 140/12940 [27:10<41:17:12, 11.61s/it]  1%|          | 141/12940 [27:22<41:17:06, 11.61s/it]  1%|          | 142/12940 [27:34<41:16:52, 11.61s/it]  1%|          | 143/12940 [27:45<41:16:20, 11.61s/it]  1%|          | 144/12940 [27:57<41:15:58, 11.61s/it]  1%|          | 145/12940 [28:08<41:15:44, 11.61s/it]  1%|          | 146/12940 [28:20<41:15:45, 11.61s/it]  1%|          | 147/12940 [28:32<41:15:39, 11.61s/it]  1%|          | 148/12940 [28:43<41:15:51, 11.61s/it]  1%|          | 149/12940 [28:55<41:15:57, 11.61s/it]  1%|          | 150/12940 [29:06<41:15:58, 11.62s/it]                                                        1%|          | 150/12940 [29:06<41:15:58, 11.62s/it]  1%|          | 151/12940 [29:18<41:15:40, 11.61s/it]  1%|          | 152/12940 [29:30<41:15:15, 11.61s/it]  1%|          | 153/12940 [29:41<41:14:50, 11.61s/it]